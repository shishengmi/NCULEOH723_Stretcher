#define Samples_Number  1   // 采样点数
#define Block_Size      1   // 调用一次arm_fir_f32处理的采样点个数
#define NumTaps        	129 // 滤波器系数个数
#include "ADS1292.h"
#include "arm_math.h"
uint8_t Init_y = 0; //用于LCD显示数据，显示初始化数据的y值
u32 ch1_data;       //ADS1292通道1数据
u32 ch2_data;       //ADS1292通道2数据
u16 point_cnt;      // 两个峰值之间的采集点数，用于计算心率

char MQTT_message[256];   //ESP8266 MQTT数据缓冲区
uint32_t blockSize = Block_Size;   // 调用一次arm_fir_f32处理的采样点个数
uint32_t numBlocks = Samples_Number/Block_Size;// 需要调用arm_fir_f32的次数

float32_t Input_data1; 														// 输入缓冲区
float32_t Output_data1;         									// 输出缓冲区
float32_t firState1[Block_Size + NumTaps - 1]; 		// 状态缓存，大小numTaps + blockSize - 1
float32_t Input_data2; 														// 输入缓冲区
float32_t Output_data2;         									// 输出缓冲区
float32_t firState2[Block_Size + NumTaps - 1]; 		// 状态缓存，大小numTaps + blockSize - 1


const float32_t BPF_5Hz_40Hz[NumTaps]  = {
    3.523997657e-05,0.0002562592272,0.0005757701583,0.0008397826459, 0.000908970891,
    0.0007304374012,0.0003793779761,4.222582356e-05,-6.521392788e-05,0.0001839015895,
    0.0007320778677, 0.001328663086, 0.001635892317, 0.001413777587,0.0006883906899,
    -0.0002056905651,-0.0007648666506,-0.0005919140531,0.0003351111372, 0.001569915912,
    0.002375603188, 0.002117323689,0.0006689901347,-0.001414557919,-0.003109993879,
    -0.003462586319, -0.00217742566,8.629632794e-05, 0.001947802957, 0.002011778764,
    -0.0002987752669,-0.004264956806, -0.00809297245,-0.009811084718,-0.008411717601,
    -0.004596390296,-0.0006214127061,0.0007985962438,-0.001978532877,-0.008395017125,
    -0.01568987407, -0.02018531598, -0.01929843985, -0.01321159769,-0.005181713495,
    -0.0001112028476,-0.001950757345, -0.01125541423,  -0.0243169684, -0.03460548073,
    -0.03605531529, -0.02662901953, -0.01020727865, 0.004513713531, 0.008002913557,
    -0.004921500571, -0.03125274926, -0.05950148031, -0.07363011688, -0.05986980721,
    -0.01351031102,  0.05752891302,   0.1343045086,   0.1933406889,   0.2154731899,
    0.1933406889,   0.1343045086,  0.05752891302, -0.01351031102, -0.05986980721,
    -0.07363011688, -0.05950148031, -0.03125274926,-0.004921500571, 0.008002913557,
    0.004513713531, -0.01020727865, -0.02662901953, -0.03605531529, -0.03460548073,
    -0.0243169684, -0.01125541423,-0.001950757345,-0.0001112028476,-0.005181713495,
    -0.01321159769, -0.01929843985, -0.02018531598, -0.01568987407,-0.008395017125,
    -0.001978532877,0.0007985962438,-0.0006214127061,-0.004596390296,-0.008411717601,
    -0.009811084718, -0.00809297245,-0.004264956806,-0.0002987752669, 0.002011778764,
    0.001947802957,8.629632794e-05, -0.00217742566,-0.003462586319,-0.003109993879,
    -0.001414557919,0.0006689901347, 0.002117323689, 0.002375603188, 0.001569915912,
    0.0003351111372,-0.0005919140531,-0.0007648666506,-0.0002056905651,0.0006883906899,
    0.001413777587, 0.001635892317, 0.001328663086,0.0007320778677,0.0001839015895,
    -6.521392788e-05,4.222582356e-05,0.0003793779761,0.0007304374012, 0.000908970891,
    0.0008397826459,0.0005757701583,0.0002562592272,3.523997657e-05
};


u8 read_data[9];					//ADS1292 data
arm_fir_instance_f32 ADS1292;
arm_fir_init_f32(&ADS1292, NumTaps, (float32_t *)BPF_5Hz_40Hz, firState2, blockSize);

uint32_t p_num=0;	  // 用于刷新心率，计数刷新峰峰值
uint32_t min[2]={0xFFFFFFFF,0xFFFFFFFF};//用来计算心率
uint32_t max[2]={0,0};//用来计算心率
uint32_t Peak;		 // 峰峰值
uint32_t BPM_LH[3];// 用于判断波峰
uint32_t point_cnt = 0 ;//计数值也用于计算心率
uint32_t mqtt_cnt = 0;//用于计数发送mqtt消息
float BPM = 0;				 // 心率初始化为80是为了在指数平滑的时候降低一开始达到正常值所要的时间
float RR[32] = {0};    //记录RR，用数组是为了计算标准差
float RR_sd = {0};     //RR标准差
uint16_t RR_i = 0;      //RR数组的索引值
float smoothed_BPM = 0;   //平滑后的BPM
float alpha = 0.1;        // 平滑因子

uint8_t tbuf1[2] = {0};
float temperature = 0;    //温度
float smoothed_temperature = 0; //指数平滑之后的温度